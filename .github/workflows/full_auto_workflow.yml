name: Rental Calendar Sync - Full Auto (6h)

on:
  schedule:
    # Executa a cada 6 horas (0:00, 6:00, 12:00, 18:00 UTC)
    - cron: '0 0,6,12,18 * * *'
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  sync-calendars:
    runs-on: ubuntu-latest
    
    steps:
      # ==================== SETUP ====================
      
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install icalendar requests python-dotenv pytz
      
      # ==================== SINCRONIZAÃ‡ÃƒO ====================
      
      - name: ðŸ”„ Run Calendar Sync
        id: sync
        env:
          AIRBNB_ICAL_URL: ${{ secrets.AIRBNB_ICAL_URL }}
          BOOKING_ICAL_URL: ${{ secrets.BOOKING_ICAL_URL }}
          VRBO_ICAL_URL: ${{ secrets.VRBO_ICAL_URL }}
          BUFFER_DAYS_BEFORE: 1
          BUFFER_DAYS_AFTER: 1
          OUTPUT_FILE: master_calendar.ics
          EMAIL_ON_ERROR: 'true'
          ERROR_EMAIL: ${{ secrets.ERROR_EMAIL }}
        run: |
          python scripts/sync_calendars.py
          echo "sync_status=success" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      # ==================== UPLOAD ====================
      
      - name: ðŸ“¤ Upload master_calendar.ics to GitHub
        if: steps.sync.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: master_calendar
          path: master_calendar.ics
          retention-days: 30
      
      - name: ðŸ“Š Upload sync.log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync_logs
          path: sync.log
          retention-days: 30
      
      # ==================== EMAIL SUCESSO ====================
      
      - name: ðŸ“§ Send Success Email
        if: steps.sync.outcome == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'âœ… SincronizaÃ§Ã£o CalendÃ¡rios Completa'
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.EMAIL_USER }}
          body: |
            SincronizaÃ§Ã£o de calendÃ¡rios concluÃ­da com sucesso!
            
            âœ… Status: OK
            ðŸ“… Data: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            â° Timestamp: $(date)
            
            ðŸ“Š Eventos processados:
            â€¢ Airbnb: âœ…
            â€¢ Booking: âœ…
            â€¢ Vrbo: âœ…
            
            ðŸ“ Ficheiro: master_calendar.ics (disponÃ­vel em Artifacts)
            
            PrÃ³ximo passo: Importar em todas as plataformas
      
      # ==================== EMAIL ERRO ====================
      
      - name: ðŸ“§ Send Error Email
        if: steps.sync.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'âŒ Erro na SincronizaÃ§Ã£o CalendÃ¡rios'
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.EMAIL_USER }}
          body: |
            Erro detectado na sincronizaÃ§Ã£o de calendÃ¡rios!
            
            âŒ Status: ERRO
            ðŸ”— Link: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            â° Timestamp: $(date)
            
            ðŸ“‹ Verifique o log para detalhes:
            
            ---LOG---
            $(cat sync.log)
            ---END---
            
            âš ï¸ AÃ§Ã£o necessÃ¡ria: Verifique URLs e configuraÃ§Ãµes
          attachments: sync.log
      
      # ==================== ESTATÃSTICAS ====================
      
      - name: ðŸ“ˆ Log Statistics
        if: always()
        run: |
          echo "=== SINCRONIZAÃ‡ÃƒO STATISTICS ==="
          echo "Timestamp: $(date)"
          echo "Status: ${{ steps.sync.outcome }}"
          echo "Run ID: ${{ github.run_id }}"
          echo ""
          echo "=== LOG SUMMARY ==="
          tail -20 sync.log || echo "Sem log disponÃ­vel"
          echo ""
          echo "=== FICHEIROS GERADOS ==="
          ls -lh master_calendar.ics 2>/dev/null || echo "Sem ficheiro ICS"
          ls -lh sync.log 2>/dev/null || echo "Sem sync.log"
